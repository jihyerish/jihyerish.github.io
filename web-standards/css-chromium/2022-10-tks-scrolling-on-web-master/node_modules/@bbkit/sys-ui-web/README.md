rplus-ui/bundles-ui/sys-ui-web
===============================================================================

This folder supports `sys-ui-web`, the [sys-ui](../bundles/sys-ui) bundle "on the web".

# Contents
- [Background](#background)
- [Using sys-ui-web](#using-sys-ui-web)
  - [1. npm install](#1-npm-install)
  - [2. Copy bbkitAssets](#2-copy-bbkitassets)
  - [3. Initialize and use](#3-initialize-and-use)
  - [3a. Use in a plain HTML](#3a-use-in-a-plain-html)
  - [3b. Use in a React app](#3b-use-in-a-react-app)
  - [Note about DataLayer](#note-about-datalayer)
- [Getting Started for BBKit Engineers](#getting-started-for-bbkit-engineers)
  - [CSS build details](#css-build-details)
- [Tests](#tests)
- [Continuous Integration](#continuous-integration)
- [sys-ui-web-ci Docker image](#sys-ui-web-ci-docker-image)

## Background

`sys-ui-web` was born from an August 2020 hackathon project to reduce coupling
between `sys-ui` widgets and the R+ environment, amongst other motivations.

- Hackathon slides: [Google Slide](https://docs.google.com/presentation/d/1-RtAca-tuoAHtfUl4ZyGT3Wwe0aubuJBb1bieFZCits/)
- Integration design doc: [Google Doc](https://docs.google.com/document/d/13Zxmadlp2A-fkTCZym39cwkS7PeUGddnDHi4vhk3WYo/)
- Introducing pull request: [#7367](https://bbgithub.dev.bloomberg.com/rplus-ui/bundles-ui/pull/7367)

## Using sys-ui-web

#### 1. npm install

The npm package is published to [Artifactory | @bbkit/sys-ui-web](https://artprod.dev.bloomberg.com/artifactory/webapp/#/packages/npm/%2540bbkit~2Fsys-ui-web/).

```
npm config set registry https://artprod.dev.bloomberg.com/artifactory/api/npm/npm-repos/
npm config set proxy bproxy.tdmz1.bloomberg.com:80
npm config set https-proxy bproxy.tdmz1.bloomberg.com:80

npm install @bbkit/sys-ui-web
```

See `{TEAM ENGDEVX:ARTIFACTORY - NPM <GO>}` or
[Team page url](https://cms.prod.bloomberg.com/team/pages/viewpage.action?spaceKey=engdevx&title=Artifactory+-+NPM),
and [Bloomberg Proxy Mappings](https://cms.prod.bloomberg.com/team/display/rnsp/Bloomberg+Proxy+Mappings)
for the latest info.

#### 2. Copy bbkitAssets

The npm package contains assets like css, fonts, images in a directory named
`bbkitAssets/`. This directory needs to be copied over to the **root** of your
web app. The `@bbkit/sys-ui-web` UI toolkit expects `bbkitAssets/` to be found
at the **root** of your web app.

```
cp -r node_modules/\@bbkit/sys-ui-web/dist/bbkitAssets path/to/app
```

#### 3. Initialize and use

`initialize(rootElement)` must be called once, before using the
`@bbkit/sys-ui-web` UI toolkit. `rootElement` is an [Element](https://developer.mozilla.org/en-US/docs/Web/API/Element)
that will host widgets from the UI toolkit.

#### 3a. Use in a plain HTML

```html
<html>
<body>
<div id="root"></div>
<script type="module">

import { createRoot } from "./node_modules/@bbkit/sys-ui-web/dist/lib.js";
import UI from "./node_modules/@bbkit/sys-ui-web/dist/ui/index.js";

const root = document.getElementById("root");
const webRoot = createRoot(root);

const label = new UI.Label();
label.text = "Hello R+!";
webRoot.render(label);

</script>
</body>
</html>
```

#### 3b. Use in a React app

```js
import { createRoot } from "@bbkit/sys-ui-web";
import UI from "@bbkit/sys-ui-web/ui";
import RUI from "@bbkit/sys-ui-web/rui";

const { React, Renderer } = RUI;

const root = document.getElementById("root");
const webRoot = createRoot(root);

const tree = (
    <RUI.StackPanel>
        <RUI.Label text="Hello React R+!" />
    </RUI.StackPanel>
);
webRoot.render(tree);
```

#### Note about DataLayer

The Hackathon and demo app use DataLayer WASM, which is really cool! However,
DataLayer WASM for sys-ui-web is currently **NOT** production ready and should
**NOT** be used; It is currently **NOT** supported.

## Getting Started for BBKit Engineers

```
cd sys-ui-web
PUPPETEER_SKIP_DOWNLOAD=true npm install
npm run dev

## Open http://localhost:3000/ in your web browser for the sys-ui-web Demo app
```

`sys-ui-web` uses [Vite](https://vitejs.dev/) to build for dev and prod.
`sys-ui-web` is essentially `sys-ui` + patches. These patches, living in
[bundles-ui/bundles/sys-ui](../bundles/sys-ui), come in 2 forms:

1. Modules needing substantial changes for the web have a `someModule.web.ts`
that coexists alongside the R+ `someModule.ts`. These `.web` modules are not
included in the R+ `sys-ui` build graph. When a module has a `.web` flavor, the
R+ version is not included in the `sys-ui-web` build graph.

2. Modules needing minor changes can guard this web code using
`if (Environemnt.isWeb) { ... }` within the same R+ module.

`sys-ui-web/src` has sys-ui-web-specific code. `sys-ui-web/bundles/sys-mock`
has modules mocking out a minimal set of native and R+ app-environment
dependencies. `sys-ui-web/index.html` is the entrypoint for the Demo app.

A few bundles are temporarily vendored using [git-subtree](https://github.com/git/git/blob/master/contrib/subtree/git-subtree.txt)
under `/sys-ui-web/vendored` and patched for the web. `/sys-ui-web/scripts`
has simple scripts to update the vendored bundles. Eventually, the patches will
be upstreamed when tooling for the web build is supported across R+ ecosystem.
The git-subtree operation should be its own commit, and web patches in one or
more commits on top. Recommendation: web patches affecting files in the
vendored bundle should be in separate commits from web patches affecting R+
and sys-ui-web files.

To build and test the production bundle:

```
npm run build
npm run preview

## Open http://localhost:4173/ in your web browser for the sys-ui-web Demo app
```

To test the production bundle from a test web app, see [Using sys-ui-web](#using-sys-ui-web)
but you can npm install from your local `bundles-ui` repo instead:

```
cd /path/to/app
npm install /path/to/bundles-ui/sys-ui-web/
```

See [vite.config.js](./vite.config.js) for plumbing that makes dev and prod builds work.

#### CSS build details

[Vite](https://vitejs.dev/guide/features.html#css-pre-processors) has built-in support for `.scss` (Sass). Except for a few Sass variable
rewrites described below, Vite mostly just works in `development` mode for
CSS. Because of the R+ widget stylesheets system (see [widgetstyleutil.ts](../bundles/sys-ui/util/widgetstatesutil.ts)),
which dynamically loads widget CSS when a widget is inserted into the
document, we need some minor plumbing on top of Vite. Only in `development`, we
need to rewrite URL strings with `.css` to `.scss` (see [sys-ui/bundle.web.js](../bundles/sys-ui/bundle.web.js));
Vite expects to see the `.scss` filename, not the post-processed `.css` extension.
In `production` mode, we need to walk the `sys-ui` and `sys-blp-ui` stylesheets
directories, and generate `.css` files from the `.scss`; This is handled in
[rollup-plugin-generate-prod-css.js](./rollup-plugin-generate-prod-css.js). The reason why Vite
doesn't automatically handle this is because we dynamically load these
stylesheets so they won't be part of the Vite build graph. Furthermore,
`bundle.web.js` handles rebasing CSS URL strings to `/bbkitAssets/`, the assets
directory in the `production` bundle.

Due to minor differences between R+ running natively vs in `sys-ui-web`, we
need to rewrite a few Sass variables:

1. [fontconfig.scss](../bundles/sys-ui/resources/styles/css/fontconfig.scss) needs its `$fontsDir` rewritten because Vite rebases url() references relative
to the current file. However, R+ assumes url() references are always relative to:
`http://bundles.bloomberg.com/sys-ui-<version>/environment/host.html`. Only in
`production`, we rewrite `$webFontsDir` to rebase to `/bbkitAssets/`. These
`$webFontsDirs` fonts are ones shipped with `wintrv.exe` and need to be
manually included for `sys-ui-web`.

2. [widgets/_common.scss](../bundles/sys-ui/resources/styles/css/widgets/_common.scss) needs a few Sass variables rewritten for the same reason
as above; R+ assumes a fixed relative base but Vite rebases url() references
relative to the current file. These Sass variables are: `$imgdir`,
`$localImgDir`, `$userwidgetImgdir`. Vite, both `development` and `production`
modes, only gives a hook into transforming the Sass modules but not the
partials (i.e. `_common.scss`). We cannot directly rewrite the Sass variables
in `_common.scss`. Since `_common.scss` only has variables and mixins, it is
safe to [@use](https://sass-lang.com/documentation/at-rules/use) `_common.scss` from every `sys-ui` Sass module. Now we can
rewrite these Sass variables in the Sass module immediately after the @use
rule using the approach described [here](https://sass-lang.com/documentation/at-rules/use#reassigning-variables).

We ensure/inject `@use "_common.scss";` in every `sys-ui` Sass module to cover
the following edge case: [combobox.normal.scss](../bundles/sys-ui/resources/styles/css/widgets/combobox/combobox.normal.scss)
currently **only** imports partials. One of its partials, somewhere down the line in
its import graph, uses `_common.scss`. Another partial [_combobox_shared](../bundles/sys-ui/resources/styles/css/widgets/combobox/_combobox_shared.scss)
has references to `common.$imgdir`, etc. Therefore, had we not injected
`@use "_common.scss";` into `combobox.normal.scss`, we would have no ability to
rewrite `common.$imgdir`, etc. since Vite only gives a hook into transforming
the Sass modules but not the partials.

In `development`, [scssAdditionalData.dev.ts](./scssAdditionalData.dev.ts) exports a function to be used in
[css.preprocessorOptions.scss.additionalData](https://vitejs.dev/config/#css-preprocessoroptions). Adding this transform to the
build pipeline is sufficient in `development` because Vite processes `.scss`
requests on-the-fly as they are dynamically loaded. In `production`, these Sass
variable rewrites need to happen when the `.css` files are generated from the
`.scss` in [rollup-plugin-generate-prod-css.js](./rollup-plugin-generate-prod-css.js). Again, dynamically loaded
stylesheets will not be in the build graph when Vite generates the `production`
bundle; This is why we have `rollup-plugin-generate-prod-css.js`.

## Tests

`sys-ui-web` uses [Web Test Runner](https://modern-web.dev/docs/test-runner/overview/) to run
UI tests, in a headless browser (Puppeteer), to ensure `sys-ui-web` remains
functional as `sys-ui` and other `bundles-ui` changes are made.

Due to Bloomberg proxy settings, Puppeteer must be downloaded separately:

```
cd sys-ui-web
PUPPETEER_SKIP_DOWNLOAD=true npm install

https_proxy=proxy.bloomberg.com:80 curl -O https://storage.googleapis.com/chromium-browser-snapshots/Win_x64/970485/chrome-win.zip

mkdir -p node_modules/puppeteer/.local-chromium/win64-970485
unzip chrome-win.zip -d node_modules/puppeteer/.local-chromium/win64-970485
rm chrome-win.zip

npm test
```

On Windows, to run the tests in watch mode, you'll need to use `winpty`
(also note `npm.cmd` vs `npm`), since Git Bash and WSL aren't recognized
as interactive TTY.

```
winpty npm.cmd run test:watch

## Press D, to launch Chromium to debug your tests
## You'll see "Chrome is being controlled by automated test software."
```

See [vite-web-test-runner-patched-plugin.js](./vite-web-test-runner-patched-plugin.js)
for plumbing that integrates Web Test Runner with Vite.

## Continuous Integration

At pull request and merge time, CI checks are run to ensure:

- `sys-ui-web` dev builds
- all headless tests pass
- the `sys-ui-web` prod bundle builds

See [Jenkinsfile.sys-ui-web](../Jenkinsfile.sys-ui-web)

## sys-ui-web-ci Docker image

`sys-ui-web/Dockerfile` is used to build the `sys-ui-web-ci` Docker image.
It is based off the widely used `bb-rapidci/engines/rhel7-node16` image, and
adds the minimal set of dependencies to support Puppeteer used by Web Test
Runner.

### Docker setup basics

```
https_proxy=bproxy.tdmz1.bloomberg.com:80 docker login artprod.dev.bloomberg.com
```

For the latest proxy settings, see: [Bloomberg Proxy Mappings](https://cms.prod.bloomberg.com/team/display/rnsp/Bloomberg+Proxy+Mappings).
If using a BBVPN laptop, you should be all set; See: [Tutti/Docker Engine](https://tutti.prod.bloomberg.com/local-development/faq#can-i-use-docker-desktop).

### Building the image

```
https_proxy=bproxy.tdmz1.bloomberg.com:80 docker build -t sys-ui-web-ci .
```

### Pushing the image

```
docker image tag sys-ui-web-ci artprod.dev.bloomberg.com/bbkit/sys-ui-web-ci:latest
docker image push artprod.dev.bloomberg.com/bbkit/sys-ui-web-ci:latest
```

You can see the image in the Artifactory web UI here:
https://artprod.dev.bloomberg.com/artifactory/webapp/#/packages/docker/bbkit~2Fsys-ui-web-ci/

`{PWHO //ID 3157507 <GO>}` and `{PVFX OBJ:ARH:NS:OCI VAL:bbkit<Go>}` support
the authorization mechanism to the `bbkit` Artifactory OCI namespace. For more
more info, see [Artifactory - Docker](https://cms.prod.bloomberg.com/team/display/engdevx/Artifactory+-+Docker)