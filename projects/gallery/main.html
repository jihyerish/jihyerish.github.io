<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <script src='setting.js'></script>
    <script async src="https://cdn.ampproject.org/v0.js"></script>
  </head>
  
  <body>
    <div id='title' class='header header-grid'>
      <span id='text'>Image gallery</span>
      <img id='closeButton' class='button' src='sourceIcons/ic_close.png'></img>
    </div>
    <div id='container' class='grid-layout'></div>
    <div id='tools' class='footer'>
      <img class='button' src='sourceIcons/ic_plus1.png'></img>
      <img class='button' src='sourceIcons/ic_comment.png'></img>
      <img class='button' src='sourceIcons/ic_add.png'></img>
      <img class='button' src='sourceIcons/ic_share.png'></img>
    </div>
  </body>

  <script>
    const imageCount = 8;
    const fileName = ['air', 'desks', 'hive', 'logo', 'lounge', 'lounge2', 'mountainview', 'racecar'];
    var imageList = null;
    const dirName = 'sourceImages/'
    const container = document.getElementById('container');
    const header = document.getElementById('title');
    const footer = document.getElementById('tools');
    let detailTargetIndex = null;

    // TODO: Fix lazy loading
    window.addEventListener('load', () => {
      loadImages(container, dirName, fileName).then(function () {
        imageList = container.childNodes;
      });      
    });
    
    document.addEventListener('click', e => {
      e.stopPropagation();
      if (container.className === 'grid-layout') {
        readyForDetailLayout(header, container, imageList, footer, e.target).then(function (index) {
          detailTargetIndex = index;
        });
      }
    });

    document.addEventListener('mouseover', e => {
      if (container.className === 'detail-layout') {
        header.style.visibility = 'visible';
        footer.style.display = 'flex';
      }
    });

    document.querySelector('#title > #closeButton').addEventListener('click', e => {
      e.stopPropagation();
      readyForGridLayout(header, imageList, footer).then(function () {
        container.className = 'grid-layout';
      });
    });

    // Move to anothor image in detailed view
    let touchstart = {
      x: 0,
      y: 0
    };
    let touchnow = {
      x: 0,
      y: 0
    };
    let touchend = {
      x: 0,
      y: 0
    };

    container.addEventListener('touchstart', e => {
      if (container.className === 'detail-layout') {
        touchstart.x = e.changedTouches[0].screenX;
        touchstart.y = e.changedTouches[0].screenY;
      }
    }, false);

    container.addEventListener('touchmove', e => {
      if (container.className === 'detail-layout') {
        touchnow.x = e.changedTouches[0].screenX;
        touchnow.y = e.changedTouches[0].screenY;

        header.style.visibility = 'hidden';
        footer.style.display = 'none';

        if (touchnow.x < touchstart.x) {
          // Swiped left: Next image
          console.log('Swiped left');
          if (detailTargetIndex < imageList.length - 1) {
            let diffPos = Math.abs(touchnow.x - touchstart.x);
            imageList[detailTargetIndex].style.transform = `translateX(${-diffPos}px)`;
            imageList[detailTargetIndex+1].style.transform = `translateX(${-diffPos}px)`;
          }
        }

        if (touchnow.x > touchstart.x) {
          // Swiped right: Previous image
          console.log('Swiped right');
          if (detailTargetIndex >= 1) {
            let diffPos = Math.abs(touchnow.x - touchstart.x);
            imageList[detailTargetIndex].style.transform = `translateX(${diffPos}px)`;
            imageList[detailTargetIndex-1].style.transform = `translateX(${diffPos}px)`;
          }
        }
      }
    });

    container.addEventListener('touchend', e => {
      touchend.x = e.changedTouches[0].screenX;
      touchend.y = e.changedTouches[0].screenY;

      if (container.className === 'detail-layout') {
        const headerTitle = header.querySelector('#text');
        const updatedIndex = handleGesture(imageList, detailTargetIndex, touchstart, touchend);
       
        if (updatedIndex => 0)
          detailTargetIndex = updatedIndex;

        headerTitle.innerText = getFileName(imageList[detailTargetIndex]);
        header.style.visibility = 'visible';
        footer.style.display = 'flex';
      }
    }, false);

  </script>
</html>
