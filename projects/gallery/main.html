<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <script src='setting.js'></script>
    <script async src="https://cdn.ampproject.org/v0.js"></script>
  </head>
  
  <body>
    <div id='title' class='header header-grid'>
      <span id='text'>Image gallery</span>
      <img id='closeButton' class='button' src='sourceIcons/ic_close.png'></img>
    </div>
    <div id='container' class='grid-layout'></div>
    <div id='tools' class='footer'>
      <img class='button' src='sourceIcons/ic_plus1.png'></img>
      <img class='button' src='sourceIcons/ic_comment.png'></img>
      <img class='button' src='sourceIcons/ic_add.png'></img>
      <img class='button' src='sourceIcons/ic_share.png'></img>
    </div>
  </body>

  <script>
    const imageCount = 8;
    const fileName = ['air', 'desks', 'hive', 'logo', 'lounge', 'lounge2', 'mountainview', 'racecar'];
    const dirName = 'sourceImages/'
    const container = document.getElementById('container');
    const header = document.getElementById('title');
    const footer = document.getElementById('tools');
    let detailTargetIndex = null;

    // TODO: Fix lazy loading
    window.addEventListener('load', () => {
      loadImages(container, dirName, fileName);      
    });
    
    document.addEventListener('click', e => {
      e.stopPropagation();
      if (container.className === 'grid-layout') {
        const imageElements = container.childNodes;

        readyForDetailLayout(header, imageElements, footer, e.target).then(function (index) {
          container.className = 'detail-layout';
          detailTargetIndex = index;
        });
      }
    });

    document.addEventListener('mouseover', e => {
      if (container.className === 'detail-layout') {
        header.style.visibility = 'visible';
        footer.style.display = 'flex';
      }
    });

    document.addEventListener('touchmove', e => {
      if (container.className === 'detail-layout') {
        header.style.visibility = 'hidden';
        footer.style.display = 'none';
      }
    });

    document.querySelector('#title > #closeButton').addEventListener('click', e => {
      e.stopPropagation();
      const imageElements = container.childNodes;
      
      readyForGridLayout(header, imageElements, footer).then(function () {
        container.className = 'grid-layout';
      });
    });

    // Move to anothor image in detailed view
    let touchstartX = 0;
    let touchstartY = 0;
    let touchendX = 0;
    let touchendY = 0;

    container.addEventListener('touchstart', e => {
      touchstartX = e.changedTouches[0].screenX;
      touchstartY = e.changedTouches[0].screenY;
    }, false);

    container.addEventListener('touchend', e => {
      touchendX = e.changedTouches[0].screenX;
      touchendY = e.changedTouches[0].screenY;

      if (container.className === 'detail-layout') {
        const imageElements = container.childNodes;
        const headerTitle = header.querySelector('#text');

        if (handleGesture(imageElements, detailTargetIndex))
          headerTitle.innerText = (imageElements[detailTargetIndex].src.split(dirName)[1]).split('.')[0];

        header.style.visibility = 'visible';
        footer.style.display = 'flex';
      }
    }, false);

  </script>
</html>
