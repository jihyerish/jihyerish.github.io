<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <script src='setting.js'></script>
    <script async src="https://cdn.ampproject.org/v0.js"></script>
  </head>
  
  <body>
    <div id='title' class='header'>
      <span id='text'>Image gallery</span>
      <img id='closeButton' class='button' src='sourceIcons/ic_close.png'></img>
    </div>
    <div id='container' class='grid-layout'></div>
    <div id='tools' class='footer'>
      <img class='button' src='sourceIcons/ic_plus1.png'></img>
      <img class='button' src='sourceIcons/ic_comment.png'></img>
      <img class='button' src='sourceIcons/ic_add.png'></img>
      <img class='button' src='sourceIcons/ic_share.png'></img>
    </div>
  </body>

  <script>
    const imageCount = 8;
    const fileName = ['air', 'desks', 'hive', 'logo', 'lounge', 'lounge2', 'mountainview', 'racecar'];
    const dirName = 'sourceImages/'
    const container = document.getElementById('container');
    let detailTargetIndex = null;

    // TODO: Fix lazy loading
    window.addEventListener('load', () => {
      for (let imageNum = 0; imageNum < imageCount; imageNum++) {
        container.appendChild(createImageElement(dirName+fileName[imageNum]+'.jpg', 'grid-image'));

        //var img2 = document.createElement('amp-img'); // Use DOM HTMLImageElement
        //img2.src = dirName + fileName[imageNum] + '.jpg';
        //img2.className = 'grid-image';
        //img2.setAttribute('layout', 'fixed');
        //container.appendChild(img2);
      }
    });
    
    document.addEventListener('click', e => {
      if (container.className === 'grid-layout') {
        const imageElements = container.childNodes;

        readyForDetailLayout(imageElements, e.target).then(function (index) {
          container.className = 'detail-layout';
          detailTargetIndex = index;
        });
      }
    });

    document.addEventListener('mouseover', e => {
      if (container.className === 'detail-layout') {
        document.getElementById('title').style.visibility = 'visible';
        document.getElementById('tools').style.display = 'flex';
      }
    });

    document.addEventListener('click', e => {
      if (container.className === 'detail-layout') {
        document.getElementById('title').style.visibility = 'visible';
        document.getElementById('tools').style.display = 'flex';
      }
    });

    document.querySelector('#title > #closeButton').addEventListener('click', e => {
      e.stopPropagation();
      const imageElements = container.childNodes;
      
      readyForGridLayout(imageElements).then(function () {
        container.className = 'grid-layout';
      });
    });
    
    // TODO: use get and set
    // TODO: Modularization
    
    function createImageElement(src, class_name) {
      let image = document.createElement('img');
      image.src = src;
      image.className = class_name;
      return image;
    }

    function readyForGridLayout(imageElements) {
      document.body.style.backgroundColor = 'white';

      const header = document.getElementById('title');
      const headerTitle = document.querySelector('#title > #text');
      const closeBtn = document.querySelector('#title > #closeButton');
      closeBtn.style.display = 'none';
      header.style.flexDirection = 'column';
      header.style.backgroundColor = '#E8E8E8';
      headerTitle.innerText = 'Image gallery';
      headerTitle.style.color = '#303030';

      document.getElementById('tools').style.display = 'none';

      imageElements.forEach(image => {
        image.style.display = 'block';
        image.style.objectFit = 'cover';
      });

      return new Promise(function (resolve) {
        resolve();
      });
    }

    function readyForDetailLayout(imageElements, target) {
      document.body.style.backgroundColor = 'black';

      const header = document.getElementById('title');
      const headerTitle = document.querySelector('#title > #text');
      const closeBtn = document.querySelector('#title > #closeButton');
      closeBtn.style.display = 'block';
      header.style.visibility = 'hidden';
      header.style.flexDirection = 'row';
      header.style.backgroundColor = '#303030';
      headerTitle.innerText = (target.src.split(dirName)[1]).split('.')[0];
      headerTitle.style.color = '#E8E8E8';

      let targetIndex = null;

      imageElements.forEach((image, index) => {
        if (image == target) {
          image.style.objectFit = 'contain';
          targetIndex = index;
        }
        else {
          image.style.display = 'none';
        }
      });

      return new Promise(function (resolve) {
        resolve(targetIndex);
      });
    }

    // Move to anothor image in detailed view
    let touchstartX = 0;
    let touchstartY = 0;
    let touchendX = 0;
    let touchendY = 0;

    container.addEventListener('touchstart', e => {
      touchstartX = e.changedTouches[0].screenX;
      touchstartY = e.changedTouches[0].screenY;
    }, false);

    container.addEventListener('touchend', e => {
      touchendX = e.changedTouches[0].screenX;
      touchendY = e.changedTouches[0].screenY;

      if (container.className === 'detail-layout') {
        const imageElements = container.childNodes;
        const headerTitle = document.querySelector('#title > #text');

        if (handleGesture(imageElements, detailTargetIndex))
          headerTitle.innerText = (imageElements[detailTargetIndex].src.split(dirName)[1]).split('.')[0];
      }
    }, false);

    // TODO: Using scroll-snap. More natural transition
    function handleGesture(imageList, targetIndex) {
      if (touchendX <= touchstartX) {
        // Swiped left: Previous image
        console.log('Swiped left');
        if (targetIndex > 0) {
          imageList[targetIndex].style.display = 'none';
          detailTargetIndex = targetIndex - 1;

          imageList[detailTargetIndex].style.objectFit = 'contain';
          imageList[detailTargetIndex].style.display = 'block';
          return true;
        }
      }

      if (touchendX >= touchstartX) {
        // Swiped right: Next image
        console.log('Swiped right');
        if (targetIndex < imageList.length - 1) {
          imageList[targetIndex].style.display = 'none';
          detailTargetIndex = targetIndex + 1;

          imageList[detailTargetIndex].style.objectFit = 'contain';
          imageList[detailTargetIndex].style.display = 'block';
          return true;
        }
      }

      return false;
    }
  </script>
</html>
